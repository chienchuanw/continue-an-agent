# Prompt Contracts Specification

## Continue.dev × Claude 4.5

This document defines **strict, enforceable prompt contracts** used across the system.

Prompt contracts exist to:

- prevent prompt drift
- ensure reproducibility
- control token usage
- separate _reasoning_, _context_, and _instructions_

No prompt may be constructed outside these contracts.

---

## 1. Core Principles

1. **Deterministic structure**
2. **Context injected only by Context Engine**
3. **No ad-hoc system prompts**
4. **Explicit token budgeting**
5. **Role separation is mandatory**

---

## 2. Global Prompt Layout

All prompts MUST follow this order:

```text
<SYSTEM>
  Identity, rules, non-negotiables

<CONTEXT>
  Retrieved files & metadata (from Context Engine only)

<TASK>
  What the model must do

<INPUT>
  User input / selection / diagnostics

<OUTPUT_CONSTRAINTS>
  Format, length, style constraints
```

No section may be omitted unless explicitly allowed.

---

## 3. System Prompt Contract

### 3.1 Purpose

The SYSTEM prompt defines:

- assistant identity
- safety boundaries
- agent behavior constraints

### 3.2 Rules

- Defined once per session
- Immutable during runtime
- Must not reference specific files

### 3.3 Example

```text
You are an AI programming assistant embedded in a code editor.
You must follow all tool and permission constraints.
You must not modify files without explicit approval.
```

---

## 4. Context Section Contract

### 4.1 Source

- ONLY generated by Context Engine
- NEVER injected manually

### 4.2 Structure

```xml
<File path="src/foo.ts">
  <Metadata>
    type: source
    score: 0.87
  </Metadata>
  <Content>
    ...
  </Content>
</File>
```

### 4.3 Rules

- Sorted by descending score
- Grouped by file
- Stable ordering

---

## 5. Task Contract

### 5.1 Purpose

Defines **what** the model must do, not **how**.

### 5.2 Examples

- "Explain the root cause of the error."
- "Refactor the code to reduce duplication."
- "Generate unit tests for the given function."

---

## 6. Input Contract

### 6.1 Allowed Inputs

- User text prompt
- Code selection
- Diagnostics / errors
- Agent tool outputs

### 6.2 Prohibited Inputs

- Entire workspace dump
- Raw git history
- Unfiltered logs

---

## 7. Output Constraints Contract

### 7.1 Purpose

Controls format, verbosity, and safety.

### 7.2 Examples

```text
- Respond in Markdown
- Do not exceed 300 words
- Output unified diff only
```

### 7.3 Mandatory for Agent Tasks

All agent prompts MUST specify:

- allowed tools
- expected output format
- stop conditions

---

## 8. Token Budget Contract

### 8.1 Budget Allocation

| Section | %         |
| ------- | --------- |
| SYSTEM  | fixed     |
| CONTEXT | 40–60%    |
| TASK    | 5–10%     |
| INPUT   | variable  |
| OUTPUT  | remainder |

### 8.2 Enforcement

- Hard truncation by Context Engine
- Never exceed model max tokens
- Fail fast if impossible

---

## 9. Prompt Types

### 9.1 Chat Prompt

Used for explanation & discussion.

- No file mutation
- No tool invocation

---

### 9.2 Edit Prompt

Used for refactors & fixes.

Must include:

- diff-only output constraint
- no commentary outside diff

---

### 9.3 Agent Prompt

Used for multi-step tasks.

Must include:

- tool allowlist
- max step count
- explicit approval requirement

---

## 10. Anti-Patterns (Forbidden)

- Inline prompt concatenation
- Mixing context with instructions
- Letting model decide context
- Dynamic system prompt mutation

Violations are merge blockers.

---

## 11. Validation Checklist

Every prompt must answer:

- Is structure compliant?
- Is context source correct?
- Is token budget respected?
- Is output constrained?

---

## 12. Definition of Done

A prompt is considered valid when:

- Given identical inputs, output is stable
- Token usage is predictable
- Behavior matches task intent

---

## 13. Guiding Principle

> **The model should never wonder  
> why it received a piece of context.**
